import os
import requests
from datetime import datetime

USERNAME = "CreepyLewis"
TOKEN = os.environ.get("GH_TOKEN")

if not TOKEN:
    raise Exception("GH_TOKEN not found")

HEADERS = {
    "Authorization": f"Bearer {TOKEN}",
    "Content-Type": "application/json"
}

QUERY = """
query($login: String!) {
  user(login: $login) {
    contributionsCollection {
      contributionCalendar {
        weeks {
          contributionDays {
            contributionCount
            date
          }
        }
      }
    }
  }
}
"""

res = requests.post(
    "https://api.github.com/graphql",
    json={"query": QUERY, "variables": {"login": USERNAME}},
    headers=HEADERS
)

data = res.json()
if "errors" in data:
    raise Exception(data["errors"])

weeks = data["data"]["user"]["contributionsCollection"]["contributionCalendar"]["weeks"]

days = [d for w in weeks for d in w["contributionDays"]]

total = sum(d["contributionCount"] for d in days)

current_streak = 0
for d in reversed(days):
    if d["contributionCount"] > 0:
        current_streak += 1
    else:
        break

longest_streak = temp = 0
for d in days:
    if d["contributionCount"] > 0:
        temp += 1
        longest_streak = max(longest_streak, temp)
    else:
        temp = 0

start_date = days[0]["date"]
end_date = datetime.today().strftime("%b %d, %Y")

svg = f"""
<svg width="800" height="180" xmlns="http://www.w3.org/2000/svg">
  <rect width="800" height="180" rx="16" fill="#161b22"/>
  <text x="30" y="35" fill="#ff9f1c" font-size="18" font-family="monospace">
    GITHUB ACTIVITY
  </text>

  <text x="30" y="75" fill="#8b949e" font-size="13" font-family="monospace">
    Total Contributions
  </text>
  <text x="30" y="110" fill="#c9d1d9" font-size="28" font-family="monospace">
    {total}
  </text>

  <text x="300" y="75" fill="#8b949e" font-size="13" font-family="monospace">
    Current Streak
  </text>
  <text x="300" y="110" fill="#c9d1d9" font-size="28" font-family="monospace">
    {current_streak}
  </text>

  <text x="550" y="75" fill="#8b949e" font-size="13" font-family="monospace">
    Longest Streak
  </text>
  <text x="550" y="110" fill="#c9d1d9" font-size="28" font-family="monospace">
    {longest_streak}
  </text>

  <text x="30" y="150" fill="#8b949e" font-size="13" font-family="monospace">
    {start_date} â€“ {end_date}
  </text>
</svg>
"""

os.makedirs("stats", exist_ok=True)
with open("stats/stats.svg", "w") as f:
    f.write(svg)
